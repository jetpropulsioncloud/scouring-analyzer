<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>View Build</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: sans-serif;
      padding: 0;
      margin: 0;
      background-color: transparent;
      background-image: none;
      color: white;
    }

    .title-bar {
      -webkit-app-region: drag;
      user-select: none;
      background-color: rgba(30, 30, 30, 0.85);
      padding: 10px 12px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .title-bar * {
      -webkit-app-region: no-drag;
    }

    .title-bar button {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      padding: 4px 10px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
    }

    .title-bar button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    #buildViewerContainer {
      max-height: 90vh;
      overflow-y: auto;
      padding: 16px;
      box-sizing: border-box;
    }

    .build-step {
      margin-left: 10px;
      margin-bottom: 5px;
    }

    .phase-header {
      margin-top: 15px;
      font-size: 15px;
      color: #ddd;
    }

    h2 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #ffda7b;
    }
  </style>
</head>
<body>
  <div class="draggable-wrapper">
    <div class="build-title-bar">
      <div class="build-title-left">
        <div class="build-title-text">Build Viewer</div>
        <div class="build-subtitle">(Requires Northgard in Windowed or Borderless Mode)</div>
      </div>
      <button onclick="closeApp()">X</button>
    </div>
    <div id="buildViewerContainer" class="no-drag-scrollable">
      <div id="buildContent"></div>
    </div>

<script>
  const { ipcRenderer } = require('electron');

  // Close the popup
  function closeApp() {
    window.close();
  }

  // Pick emoji for a step
  function getEmojiForStep(step) {
    const s = step.toLowerCase();
    if (s.includes("wood") || s.includes("lodge")) return "ğŸŒ²";
    if (s.includes("house")) return "ğŸ ";
    if (s.includes("scout")) return "ğŸ§­";
    if (s.includes("colonize")) return "ğŸ“";
    if (s.includes("training") || s.includes("military")) return "âš”ï¸";
    if (s.includes("feast")) return "ğŸ½ï¸";
    if (s.includes("clear") || s.includes("attack")) return "ğŸ›¡ï¸";
    if (s.includes("trade post")) return "ğŸ¦";
    if (s.includes("warchief")) return "ğŸª“";
    if (s.includes("brewery")) return "ğŸº";
    if (s.includes("mine") || s.includes("mining")) return "â›ï¸";
    if (s.includes("fish")) return "ğŸŸ";
    if (s.includes("merchant")) return "ğŸ›ï¸";
    if (s.includes("fisherman")) return "ğŸ£";
    if (s.includes("forge")) return "ğŸ› ï¸";
    if (s.includes("altar")) return "ğŸ•¯ï¸";
    if (s.includes("relic")) return "ğŸ—¿";
    if (s.includes("ready")) return "âœ…";
    return "â€¢";
  }

  // Show steps in the build
  function renderBuildSteps(steps) {
    return (steps || []).map(step => {
      if (step.startsWith("#")) {
        return `<h4 class="phase-header">ğŸ“… ${step.slice(1).trim()}</h4>`;
      }
      return `<div class="build-step">${getEmojiForStep(step)} ${step}</div>`;
    }).join("");
  }

  // Listen for the build data from main
  ipcRenderer.on('load-build', (event, build) => {
    const tags = (build.situationalTags || []).join(', ') || 'None';
    const html = `
      <h2>${build.name} (${build.clan})</h2>
      ${build.militaryPath ? `<p><strong>âš”ï¸ Military Path:</strong> ${build.militaryPath}</p>` : ''}
      <button id="toggleLoreBtn">ğŸ“œ Show Lore</button>
      <div id="loreViewer" style="display:none; margin-top: 16px;"></div>
      <p><strong>ğŸŒ Tags:</strong> ${tags}</p>
      <hr>
      <div>${renderBuildSteps(build.steps)}</div>
    `;
    document.getElementById('buildContent').innerHTML = html;

    const toggleLoreBtn = document.getElementById("toggleLoreBtn");
    const loreViewer = document.getElementById("loreViewer");

    toggleLoreBtn.addEventListener("click", () => {
      if (loreViewer.style.display === "none") {
        showLore(build);
        loreViewer.style.display = "block";
        toggleLoreBtn.textContent = "ğŸ“œ Hide Lore";
      } else {
        loreViewer.style.display = "none";
        toggleLoreBtn.textContent = "ğŸ“œ Show Lore";
      }
    });
  });

  // Show the lore tree in read-only mode
  function showLore(build) {
    const container = document.getElementById("loreViewer");
    container.innerHTML = "";

    const order = build.loreOrder || [];
    if (order.length === 0) {
      container.innerHTML = "<p><em>No lore order available.</em></p>";
      return;
    }

    const looksNumeric = (v) => Number.isFinite(v) || /^\d+$/.test(String(v));
    const isTree = (build.loreMode === 'tree') || order.every(looksNumeric);

    if (isTree) {
      const iframe = document.createElement("iframe");
      iframe.src = "lore-tree.html";
      iframe.style.cssText = "width:100%;height:400px;border:none;border-radius:8px;";
      iframe.onload = () => {
        try {
          const idx = order.map(n => parseInt(n, 10));
          iframe.contentWindow.setSelectedLoreIndexes(idx);
        } catch (err) {
          console.error("Failed to set lore:", err);
        }
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        const style = doc.createElement('style');
        style.textContent = `
          button, [role="button"], a, input, select, textarea, .clickable {
            pointer-events: none !important;
          }
        `;
        doc.head.appendChild(style);
      };
      container.appendChild(iframe);
      iframe.style.pointerEvents = "none";
    } else {
      const items = order.map((l, i) => `<li>${i + 1}. ${l}</li>`).join('');
      container.innerHTML = `<div><strong>ğŸ“œ Lore Order:</strong><ul>${items}</ul></div>`;
    }
  }
</script>
</body>
</html>
