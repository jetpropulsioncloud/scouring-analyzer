<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'nonce-vb1';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data:;
    font-src 'self';
    connect-src 'self' https://firestore.googleapis.com https://*.firebaseio.com https://www.googleapis.com;
    frame-src 'self';
    object-src 'none';
    base-uri 'self';
  ">
  <meta charset="UTF-8">
  <title>View Build</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: sans-serif;
      padding: 0;
      margin: 0;
      background-color: rgba(30, 30, 30, 0.4);
      background-image: none;
      color: white;
    }
    .title-bar {
      -webkit-app-region: drag;
      user-select: none;
      background-color: rgba(30, 30, 30, 0.85);
      padding: 10px 12px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .title-bar * { -webkit-app-region: no-drag; }
    .title-bar button {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 4px 10px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
    }
    .title-bar button:hover { background: rgba(255,255,255,0.2); }

    #buildViewerContainer {
      max-height: 90vh;
      overflow-y: auto;
      padding: 16px;
      box-sizing: border-box;
    }
    .build-step { margin-left: 10px; margin-bottom: 5px; }
    .phase-header { margin-top: 15px; font-size: 15px; color: #ddd; }
    h2 { font-size: 18px; margin-bottom: 10px; color: #ffda7b; }

    .btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn:hover { background: rgba(255,255,255,0.2); }
    .images-panel img {
      max-width: 280px;
      display: block;
      margin: 8px 0;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="draggable-wrapper">
    <div class="build-title-bar">
      <div class="build-title-left">
        <div class="build-title-text">Build Viewer</div>
        <div class="build-subtitle">(Requires The Scouring in Windowed or Borderless Mode)</div>
      </div>
      <button id="closeBtn">X</button>
    </div>
    <div id="buildViewerContainer" class="no-drag-scrollable">
      <div id="buildContent"></div>
    </div>

<script nonce="vb1">
  const ipcRenderer =
    (typeof require === 'function' && (() => { try { return require('electron').ipcRenderer; } catch (e) { return null; } })()) ||
    window.ipc || null;

  function closeApp() { window.close(); }

  function getEmojiForStep(step) {
    const s = String(step || '').toLowerCase();
    if (s.includes("wood") || s.includes("lodge")) return "üå≤";
    if (s.includes("house")) return "üè†";
    if (s.includes("scout")) return "üß≠";
    if (s.includes("colonize")) return "üìç";
    if (s.includes("training") || s.includes("military")) return "‚öîÔ∏è";
    if (s.includes("feast")) return "üçΩÔ∏è";
    if (s.includes("clear") || s.includes("attack")) return "üõ°Ô∏è";
    if (s.includes("trade post") || s.includes("trading post")) return "üè¶";
    if (s.includes("warchief")) return "ü™ì";
    if (s.includes("brewery")) return "üç∫";
    if (s.includes("mine") || s.includes("mining")) return "‚õèÔ∏è";
    if (s.includes("fish")) return "üêü";
    if (s.includes("merchant")) return "üõçÔ∏è";
    if (s.includes("fisherman")) return "üé£";
    if (s.includes("forge")) return "üõ†Ô∏è";
    if (s.includes("altar")) return "üïØÔ∏è";
    if (s.includes("relic")) return "üóø";
    if (s.includes("ready")) return "‚úÖ";
    return "‚Ä¢";
  }

  function renderBuildSteps(steps) {
    const arr = Array.isArray(steps) ? steps : [];
    return arr.map(text => {
      text = String(text || "");
      if (text.startsWith("#")) return `<h4 class="phase-header">üìÖ ${text.slice(1).trim()}</h4>`;
      return `<div class="build-step">${getEmojiForStep(text)} ${text}</div>`;
    }).join("");
  }

  function resolveMapImages(build) {
    if (Array.isArray(build.mapImages) && build.mapImages.length) return build.mapImages.filter(Boolean);
    if (Array.isArray(build.applicableMaps)) {
      const imgs = build.applicableMaps.map(m => {
        if (typeof m === 'string') return (window.MAPS_LOOKUP?.[m] || '');
        if (m && typeof m === 'object') return (m.image || '');
        return '';
      }).filter(Boolean);
      if (imgs.length) return imgs;
    }
    return [];
  }

  function renderBuild(build) {
    const name = build.name || build.title || "Untitled Build";
    const clan = build.clan || build.faction || "Unknown";
    const steps = build.steps || build.macroSteps || [];
    const tags = Array.isArray(build.situationalTags) ? build.situationalTags
               : Array.isArray(build.tags) ? build.tags : [];
    const tagsText = tags.length ? tags.join(", ") : "None";

    const maps = Array.isArray(build.applicableMaps) ? build.applicableMaps : [];
    const mapNames = maps.map(m => (typeof m === 'string' ? m : (m?.name || ''))).filter(Boolean);
    const mapsLine = mapNames.length ? `<p><strong>üó∫Ô∏è Maps:</strong> ${mapNames.join(', ')}</p>` : '';

    const images = resolveMapImages(build);
    const imagesButton = images.length ? `<button id="toggleImagesBtn" class="btn">üñºÔ∏è Show Map Images</button>` : '';
    const imagesPanel = images.length
      ? `<div id="imagesPanel" class="images-panel" style="display:none;margin:8px 0;">
           ${images.map(src => `<img src="${src}" alt="Map image">`).join('')}
         </div>`
      : '';

    const html = `
      <h2>${name} (${clan})</h2>
      <p><strong>üåç Tags:</strong> ${tagsText}</p>
      ${mapsLine}
      ${imagesButton}
      ${imagesPanel}
      <hr>
      <div>${renderBuildSteps(steps)}</div>
    `;
    const slot = document.getElementById("buildContent");
    if (slot) slot.innerHTML = html;

    const imgBtn = document.getElementById("toggleImagesBtn");
    const panel = document.getElementById("imagesPanel");
    if (imgBtn && panel) {
      imgBtn.addEventListener("click", () => {
        const show = panel.style.display === "none";
        panel.style.display = show ? "block" : "none";
        imgBtn.textContent = show ? "üñºÔ∏è Hide Map Images" : "üñºÔ∏è Show Map Images";
      });
    }

    const btn = document.getElementById("toggleLoreBtn");
    const loreViewer = document.getElementById("loreViewer");
    if (btn && loreViewer) {
      btn.addEventListener("click", () => {
        const showing = loreViewer.style.display !== "none";
        loreViewer.style.display = showing ? "none" : "block";
        btn.textContent = showing ? "üìú Show Lore" : "üìú Hide Lore";
        if (!showing && typeof window.showLore === 'function') window.showLore(build);
      });
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const closeBtn = document.getElementById("closeBtn");
    if (closeBtn) closeBtn.addEventListener("click", closeApp);
  });

  if (ipcRenderer && typeof ipcRenderer.on === 'function') {
    ipcRenderer.on('build-data', (_evt, build) => renderBuild(build || {}));
    ipcRenderer.on('load-build', (_evt, build) => renderBuild(build || {}));
    if (typeof ipcRenderer.send === 'function') ipcRenderer.send('request-build-data');
  } else {
    renderBuild({
      name: "Sample Fast-Expand",
      clan: "Raven",
      steps: ["# 800", "Queue 2 Villagers", "Build Scout Camp", "Scout 3 tiles", "# 801", "Build Training Camp", "Train 2 Warriors"],
      situationalTags: ["Greedy", "Safe opener"],
      applicableMaps: ["Eldenvale", "Mountain Pass"],
      mapImages: ["assets/maps/eldenvale.png","assets/maps/mountain_pass.png"]
    });
  }
</script>
</body>
</html>
