<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    base-uri 'self';
    object-src 'none';

    script-src 'self' https://www.gstatic.com 'nonce-firebase-123';

    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https://firebasestorage.googleapis.com;

    connect-src
      'self'
      https://firestore.googleapis.com
      https://*.firebaseio.com
      https://identitytoolkit.googleapis.com
      https://securetoken.googleapis.com
      https://www.googleapis.com
      https://firebasestorage.googleapis.com;

    frame-src 'self';
  ">
  <link rel="icon" type="image/x-icon" href="assets/scouring-icon.ico">
  <meta charset="UTF-8">
  <title>The Grand Lodge</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background-color: rgba(0, 0, 0, 0.2);
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    nav button {
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
    }
    .tab-content { padding: 10px; }
    .title-bar {
      -webkit-app-region: drag;
      cursor: move;
      font-weight: bold;
      font-size: 16px;
      background-color: rgba(255, 255, 255, 0.07);
      padding: 10px;
      border-radius: 8px 8px 0 0;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .title-bar * { -webkit-app-region: no-drag; }
    .map-preview { margin: 8px 0 16px; }
    .map-preview img { width: 100%; max-width: 280px; height: auto; border-radius: 8px; display: block; }
    .map-preview .map-name { font-weight: 600; margin-top: 6px; }
  </style>
</head>
<body>

<div class="title-bar">
  <span>
    <img src="assets/scouring-icon.ico" style="height: 20px; vertical-align: middle; margin-right: 8px;" alt="App icon">
    The Grand Lodge
  </span>
  <div>
    <button id="logoutBtn">Logout</button>
    <button id="closeBtn">X</button>
  </div>
</div>

<div id="login-screen" class="login-box">
  <h3>The Grand Lodge â€” Login / Register</h3>
  <input type="text" id="loginIdentifier" placeholder="Email or Username" />
  <br><br>
  <input type="password" id="password" placeholder="Password" />
  <br><br>
  <br>
  <label><input type="checkbox" id="stayLoggedIn"> Stay Logged In</label>
  <br><br>
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
  <button id="forgotPasswordBtn">Forgot Password?</button>
  <p id="authStatus"></p>
</div>

<div id="register-screen" class="login-box" style="display: none;">
  <h3>Create an Account</h3>
  <input type="text" id="reg-username" placeholder="Username" />
  <br><br>
  <input type="email" id="reg-email" placeholder="Email" />
  <br><br>
  <input type="password" id="reg-password" placeholder="Password" />
  <br><br>
  <button id="finalizeRegisterBtn">Register</button>
  <button id="backToLoginBtn">Back to Login</button>
  <p id="registerStatus"></p>
</div>

<div id="home-screen" style="display: none;">
  <div class="content-wrapper">
    <nav>
      <button id="tab-build">Current Builds</button>
      <button id="tab-post">Post Build</button>
      <button id="tab-profile">Profile</button>
    </nav>

    <div id="build-tab" class="tab-content">
      <div class="overlay">
        <h2>Builds</h2>

        <label for="clanFilter"><strong>Filter by Faction:</strong></label>
        <select id="clanFilter">
          <option value="All">All Factions</option>
          <option value="Human">Human</option>
          <option value="Orc">Orc</option>
        </select>
        <br><br>

        <select id="buildSelector"></select>
        <div id="buildListContainer">
          <button id="refreshBuildsBtn">ðŸ”„ Refresh Builds</button>
          <ul id="buildList"></ul>
        </div>
      </div>
    </div>

    <div id="profile-tab" class="tab-content" style="display: none;">
      <div class="overlay">
        <h2>Your Builds</h2>
        <div id="profileBuildsContainer">
          <p>Loading your builds...</p>
        </div>
      </div>
    </div>

    <div id="post-tab" class="tab-content" style="display: none;">
      <div class="overlay">
        <h2>Submit Your Build</h2>

        <div class="situational-tags-container">
          <button id="toggleSituationalTags" class="collapsible">+ Applicable Maps</button>
          <div id="situationalTagsContent" class="content" style="display: none;">
            <label for="mapTag1">Select Map:</label>
            <select id="mapTag1"></select>
            <div id="mapTag1Preview" class="map-preview"></div>

            <label for="mapTag2">Select Another Map:</label>
            <select id="mapTag2"></select>
            <div id="mapTag2Preview" class="map-preview"></div>
          </div>
        </div>

        <label for="newName" class="input-label">Build Name:</label>
        <input id="newName" type="text" placeholder="Build Name" />
        <br><br>

        <label for="newClan"><strong>Faction:</strong></label>
        <select id="newClan">
          <option value="" disabled selected>Select Faction</option>
          <option value="Human">Human</option>
          <option value="Orc">Orc</option>
        </select>

        <br><br>
        <label><strong>Upgrades:</strong></label><br>
        <textarea id="upgrades" rows="3" placeholder="One upgrade per line"></textarea>

        <h3>Phases</h3>
        <div id="yearly-builds"></div>

        <br><br>
        <button id="submitBuild">Submit Build</button>
        <p id="statusMsg"></p>
      </div>
    </div>
  </div>
</div>

<script type="module" nonce="firebase-123">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    sendPasswordResetEmail,
    onAuthStateChanged,
    setPersistence,
    browserLocalPersistence,
    browserSessionPersistence
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import {
    getFirestore,
    collection,
    getDocs,
    getDoc,
    addDoc,
    query,
    setDoc,
    where,
    deleteDoc,
    doc,
    updateDoc
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA4eog5dcEZg-S8za8QEakjx-9YM6JO6hU",
    authDomain: "scouringanalyzer.firebaseapp.com",
    databaseURL: "https://scouringanalyzer-default-rtdb.firebaseio.com",
    projectId: "scouringanalyzer",
    storageBucket: "scouringanalyzer.firebasestorage.app",
    messagingSenderId: "1058489343807",
    appId: "1:1058489343807:web:c45053c36c65aeee753d8a",
    measurementId: "G-1DT19P4LEV"
  };


  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  window.db = db;
  window.auth = auth;
  window.collection = collection;
  window.getDocs = getDocs;
  window.addDoc = addDoc;
  window.query = query;
  window.where = where;
  window.deleteDoc = deleteDoc;
  window.setDoc = setDoc;
  window.doc = doc;
  window.updateDoc = updateDoc;
  window.getDoc = getDoc;

  window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.sendPasswordResetEmail = sendPasswordResetEmail;
  window.onAuthStateChanged = onAuthStateChanged;
  window.setPersistence = setPersistence;
  window.browserLocalPersistence = browserLocalPersistence;
  window.browserSessionPersistence = browserSessionPersistence;

  console.log("âœ… Firebase initialized and exposed globally.");
</script>

<script src="renderer.js"></script>

<input type="text" id="focusTrap" style="position:absolute; opacity:0; pointer-events:none;">
<div id="updateProgressContainer" style="display:none; position: fixed; bottom: 10px; left: 10px; right: 10px; background: #222; color: white; padding: 10px; border-radius: 8px;">
  ðŸ”„ Downloading update... <progress id="updateProgressBar" value="0" max="100"></progress>
  <span id="updateProgressText">0%</span>
</div>

</body>
</html>
